# Compare records count between source (oracle) and Target (Redshift)
#!/bin/sh

WORKSPACE=${CI_PROJECT_DIR}
source $WORKSPACE/config/${env}-config.properties
echo "WORKSPACE: $WORKSPACE"

cd $WORKSPACE

result_file=$1
status_file=$2
error_flag="false"

if [[ -f "$result_file" ]]; then
   rm -rf "$result_file"
fi

if [[ -f "$status_file" ]]; then
   rm -rf "$status_file"
fi

connect_db_oracle=host_oracle_url
connectString_oracle=${!connect_db_oracle}

aws_profile=profile
profile=${!aws_profile}

devops_aws_profile=devops_profile
devops_profile=${!devops_aws_profile}

s3=s3_bucket
bucketname=${!s3}

ssm_env=ssm
ssm=${!ssm_env}

aws_region=region
region=${!aws_region}

git=git_branch
git_env=${!git}

if [[ $connectString_oracle == "" ]]; then
    echo "Add connection details in connect_db_oracle for $env"
    exit 1;
else
    echo "Connection String Oracle: $connectString_oracle"
fi

if [[ $host_redshift == "" ]]; then
    echo "Add connection details in host_redshift for $env"
    exit 1;
else
    echo "Connection String Redshift: $host_redshift"
fi

if [[ $profile == "" ]]; then
    echo "Add AWS profile details in awsprofiledetails for $env"
    exit 1;
else        
    echo "AWS PROFILE: $profile"
fi

## get s3 logs for forward scripts
export AWS_PROFILE=$profile

#creating path for oracle and redshift sql file
sql_file_oracle=$WORKSPACE/dms-scripts/nbophistory_check_count_oracle.sql
sql_file_redshift=$WORKSPACE/dms-scripts/nbophistory_check_count_redshift.sql
echo "Oracle file: $sql_file_oracle"
echo "Redshift file: $sql_file_redshift"

echo "ORACLE USER: $user_oracle"
echo "REDSHIFT USER: $user_redshift"

## fetch ssm parameters from hmno devops
ssmval_oracle=nsl-hmno-db-$schema_oracle-$ssm
ssmval_redshift=nsl-hmno-db-redshift-$ssm

export AWS_PROFILE=$devops_profile
echo "Fetch password from ssm $ssmval_oracle"
echo "Fetch password from ssm $ssmval_redshift"

oracle_passwrd=$(aws ssm get-parameters --names $ssmval_oracle --region $region --with-decryption --query Parameters[0].Value)
redshift_passwrd=$(aws ssm get-parameters --names $ssmval_redshift --region $region --with-decryption --query Parameters[0].Value)

#removing quotes(") from redshift_passwrd, as it's creating issue in redshift password
redshift_passwrd=$(echo "$redshift_passwrd" | sed 's|"||g' )

if [[ ${oracle_passwrd} == "null" ]]; then
    echo "\"$ssmval_oracle\" key not found in SSM Parameter store in HMNO DEVOPS $region region"
    exit 1;
fi

if [[ ${redshift_passwrd} == "null" ]]; then
    echo "\"$ssmval_redshift\" key not found in SSM Parameter store in HMNO DEVOPS $region region"
    exit 1;
fi

echo "**** Starting oracle sql queries execution ****"
constr=$user_oracle/$oracle_passwrd@$connectString_oracle
oracle_log_file=$WORKSPACE/oracle_logs.txt
python3 db_utilities.py "checkCountOracle" "$sql_file_oracle" "$constr" > $oracle_log_file

if [[ "$?" != "0" ]]; then
   echo "something went wrong in script execution"
   echo "Error during executing the oracle script for validation." > $result_file
   error_flag="true"
fi

cat $oracle_log_file
echo "**** Execution done, checking for error ****"

if grep -q "ERROR" $oracle_log_file
then
 echo "Error during executing the oracle script. Exiting the job with code:1"
 echo "Error during executing the oracle script for validation." > $result_file
 error_flag="true"
else
  echo "Oracle script executed successfully"
fi

echo "**** Starting Redshift sql queries execution ****"
redshift_log_file=$WORKSPACE/redshift_logs.txt
python3 db_utilities.py "checkCountRedshift" "$sql_file_redshift" "$host_redshift" "$port_redshift" "$db_name_redshift" "$user_redshift" "$redshift_passwrd" > $redshift_log_file

if [[ "$?" != "0" ]]; then
   echo "something went wrong in script execution"
   echo "Error during executing the redshift script for validation." > $result_file
   error_flag="true"
fi

cat $redshift_log_file
echo "**** Execution done, checking for error ****"

if grep -q "ERROR" $redshift_log_file
then
 echo "Error during executing the redshift script. Exiting the job with code:1"
 echo "Error during executing the redshift script for validation." > $result_file
 error_flag="true"
else
  echo "Redshift script executed successfully"
fi

echo "Comparing generated files for validation"
result=$(python3 db_utilities.py "compareFiles" "$oracle_log_file" "$redshift_log_file")

if [[ "$?" != "0" ]]; then
   echo "something went wrong in script execution"
   error_flag="true"
fi

IFS='|' read -ra keys <<< "$result"

matching_keys="${keys[0]}"
non_matching_keys="${keys[1]}"

if [[ ("$matching_keys" == "") || ("$non_matching_keys" != "") ]]; then
	echo "non_matching_keys: $non_matching_keys"
	echo "Validation failed"
	echo "Validation of source oracle and target redshift is failed." > $result_file
	error_flag="true"
else
	echo "Validation passed"
	echo "Validation of source oracle and target redshift is passed." > $result_file
fi

if [[ "$error_flag" == "true" ]]; then 
   echo "FAILED" > $status_file
else
   echo "SUCCESS" > $status_file
fi
